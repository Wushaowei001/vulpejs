"use strict";angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function(e,t){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",buttonLabel:"@",directiveId:"@",helperElements:"@",isDisabled:"=",itemLabel:"@",maxLabels:"@",orientation:"@",selectionMode:"@",minSearchLength:"@",tickProperty:"@",disableProperty:"@",groupProperty:"@",searchProperty:"@",maxHeight:"@",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"isteven-multi-select.htm",link:function(l,n,r){function o(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",l="",n=0;e>n;n++)l+=t.charAt(Math.floor(Math.random()*t.length));return l}l.backUp=[],l.varButtonLabel="",l.spacingProperty="",l.indexProperty="",l.orientationH=!1,l.orientationV=!0,l.filteredModel=[],l.inputLabel={labelFilter:""},l.tabIndex=0,l.lang={},l.localModel=[];var i=0,a=[],d=0,s="",p=!1,u=[],c=0,f=null;l.clearClicked=function(e){l.inputLabel.labelFilter="",l.updateFilter(),l.select("clear",e)},l.numberToArray=function(e){return new Array(e)},l.searchChanged=function(){return l.inputLabel.labelFilter.length<c&&l.inputLabel.labelFilter.length>0?!1:void l.updateFilter()},l.updateFilter=function(){l.filteredModel=[];var e=0;if("undefined"==typeof l.localModel)return!1;for(e=l.localModel.length-1;e>=0;e--){"undefined"!=typeof l.localModel[e][l.groupProperty]&&l.localModel[e][l.groupProperty]===!1&&l.filteredModel.push(l.localModel[e]);var n=!1;if("undefined"==typeof l.localModel[e][l.groupProperty]){if("undefined"!=typeof r.searchProperty&&""!==l.searchProperty){for(var o in l.localModel[e])if("boolean"!=typeof l.localModel[e][o]&&String(l.localModel[e][o]).toUpperCase().indexOf(l.inputLabel.labelFilter.toUpperCase())>=0&&l.searchProperty.indexOf(o)>-1){n=!0;break}}else for(var o in l.localModel[e])if("boolean"!=typeof l.localModel[e][o]&&String(l.localModel[e][o]).toUpperCase().indexOf(l.inputLabel.labelFilter.toUpperCase())>=0){n=!0;break}n===!0&&l.filteredModel.push(l.localModel[e])}"undefined"!=typeof l.localModel[e][l.groupProperty]&&l.localModel[e][l.groupProperty]===!0&&("undefined"!=typeof l.filteredModel[l.filteredModel.length-1][l.groupProperty]&&l.filteredModel[l.filteredModel.length-1][l.groupProperty]===!1?l.filteredModel.pop():l.filteredModel.push(l.localModel[e]))}l.filteredModel.reverse(),t(function(){if(l.getFormElements(),l.inputLabel.labelFilter.length>c){var e=[];angular.forEach(l.filteredModel,function(t){if("undefined"!=typeof t&&"undefined"==typeof t[l.groupProperty]){var n=angular.copy(t),r=e.push(n);delete e[r-1][l.indexProperty],delete e[r-1][l.spacingProperty]}}),l.onSearchChange({data:{keyword:l.inputLabel.labelFilter,result:e}})}},0)},l.getFormElements=function(){u=[];for(var e=n.children().children().next().children().children()[0].getElementsByTagName("button"),t=n.children().children().next().children().children().next()[0].getElementsByTagName("input"),l=n.children().children().next().children().children().next()[0].getElementsByTagName("button"),r=n.children().children().next().children().next()[0].getElementsByTagName("input"),o=0;o<e.length;o++)u.push(e[o]);for(var o=0;o<t.length;o++)u.push(t[o]);for(var o=0;o<l.length;o++)u.push(l[o]);for(var o=0;o<r.length;o++)u.push(r[o])},l.isGroupMarker=function(e,t){return"undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===t?!0:!1},l.removeGroupEndMarker=function(e){return"undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!1?!1:!0},l.displayHelper=function(e){if(r.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()){switch(e.toUpperCase()){case"ALL":return!1;case"NONE":return!1;case"RESET":if("undefined"==typeof r.helperElements)return!0;if(r.helperElements&&l.helperElements.toUpperCase().indexOf("RESET")>=0)return!0;break;case"FILTER":if("undefined"==typeof r.helperElements)return!0;if(r.helperElements&&l.helperElements.toUpperCase().indexOf("FILTER")>=0)return!0}return!1}return"undefined"==typeof r.helperElements?!0:r.helperElements&&l.helperElements.toUpperCase().indexOf(e.toUpperCase())>=0?!0:!1},l.syncItems=function(e,n,o){if(n.preventDefault(),n.stopPropagation(),"undefined"!=typeof r.disableProperty&&e[l.disableProperty]===!0)return!1;if("undefined"!=typeof r.isDisabled&&l.isDisabled===!0)return!1;if("undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!1)return!1;var a=l.filteredModel.indexOf(e);if("undefined"!=typeof e[l.groupProperty]&&e[l.groupProperty]===!0){if(r.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase())return!1;var s,p,u=0,c=l.filteredModel.length-1,g=[],y=0;for(s=a;s<l.filteredModel.length&&!(0===y&&s>a);s++)if("undefined"!=typeof l.filteredModel[s][l.groupProperty]&&l.filteredModel[s][l.groupProperty]===!0)0===g.length&&(u=s+1),y+=1;else if("undefined"!=typeof l.filteredModel[s][l.groupProperty]&&l.filteredModel[s][l.groupProperty]===!1){if(y-=1,g.length>0&&0===y){var h=!0;for(c=s,p=0;p<g.length;p++)if("undefined"!=typeof g[p][l.tickProperty]&&g[p][l.tickProperty]===!1){h=!1;break}if(h===!0)for(p=u;c>=p;p++)"undefined"==typeof l.filteredModel[p][l.groupProperty]&&("undefined"==typeof r.disableProperty?(l.filteredModel[p][l.tickProperty]=!1,b=l.filteredModel[p][l.indexProperty],l.localModel[b][l.tickProperty]=!1):l.filteredModel[p][l.disableProperty]!==!0&&(l.filteredModel[p][l.tickProperty]=!1,b=l.filteredModel[p][l.indexProperty],l.localModel[b][l.tickProperty]=!1));else for(p=u;c>=p;p++)"undefined"==typeof l.filteredModel[p][l.groupProperty]&&("undefined"==typeof r.disableProperty?(l.filteredModel[p][l.tickProperty]=!0,b=l.filteredModel[p][l.indexProperty],l.localModel[b][l.tickProperty]=!0):l.filteredModel[p][l.disableProperty]!==!0&&(l.filteredModel[p][l.tickProperty]=!0,b=l.filteredModel[p][l.indexProperty],l.localModel[b][l.tickProperty]=!0))}}else g.push(l.filteredModel[s])}else{if(r.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()){for(s=0;s<l.filteredModel.length;s++)l.filteredModel[s][l.tickProperty]=!1;for(s=0;s<l.localModel.length;s++)l.localModel[s][l.tickProperty]=!1;l.filteredModel[a][l.tickProperty]=!0,l.toggleCheckboxes(n)}else l.filteredModel[a][l.tickProperty]=!l.filteredModel[a][l.tickProperty];var b=l.filteredModel[a][l.indexProperty];l.localModel[b][l.tickProperty]=l.filteredModel[a][l.tickProperty]}f=angular.copy(e),null!==f&&t(function(){delete f[l.indexProperty],delete f[l.spacingProperty],l.onItemClick({data:f}),f=null},0),l.refreshOutputModel(),l.refreshButton(),i=l.tabIndex,l.tabIndex=o+d,n.target.focus(),l.removeFocusStyle(i),l.setFocusStyle(l.tabIndex)},l.refreshOutputModel=function(){l.outputModel=[],angular.forEach(l.localModel,function(e){if("undefined"!=typeof e&&"undefined"==typeof e[l.groupProperty]&&e[l.tickProperty]===!0){var t=angular.copy(e),n=l.outputModel.push(t);delete l.outputModel[n-1][l.indexProperty],delete l.outputModel[n-1][l.spacingProperty]}})},l.refreshButton=function(){l.varButtonLabel="";var t=0;if(0===l.outputModel.length)l.varButtonLabel=l.lang.nothingSelected;else{var n=l.outputModel.length;"undefined"!=typeof l.maxLabels&&""!==l.maxLabels&&(n=l.maxLabels),l.more=l.outputModel.length>n?!0:!1,angular.forEach(l.outputModel,function(e){"undefined"!=typeof e&&(n>t&&(l.varButtonLabel+=(l.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+l.writeLabel(e,"buttonLabel")),t++)}),l.more===!0&&(n>0&&(l.varButtonLabel+=", ... "),l.varButtonLabel+="("+l.outputModel.length+")")}l.varButtonLabel=e.trustAsHtml(l.varButtonLabel+'<span class="caret"></span>')},l.itemIsDisabled=function(e){return"undefined"!=typeof r.disableProperty&&e[l.disableProperty]===!0?!0:l.isDisabled===!0?!0:!1},l.writeLabel=function(t,n){var r=l[n].split(" "),o="";return angular.forEach(r,function(e){t[e]&&(o+="&nbsp;"+e.split(".").reduce(function(e,t){return e[t]},t))}),"BUTTONLABEL"===n.toUpperCase()?o:e.trustAsHtml(o)},l.toggleCheckboxes=function(){var e=n.children()[0];if(angular.element(document).off("click",l.externalClickListener),angular.element(document).off("keydown",l.keyboardListener),l.inputLabel.labelFilter="",l.updateFilter(),angular.element(s).hasClass("show"))angular.element(s).removeClass("show"),angular.element(e).removeClass("buttonClicked"),angular.element(document).off("click",l.externalClickListener),angular.element(document).off("keydown",l.keyboardListener),l.removeFocusStyle(l.tabIndex),t(function(){l.onClose()},0),n.children().children()[0].focus();else{a=[],d=0,angular.element(s).addClass("show"),angular.element(e).addClass("buttonClicked"),angular.element(document).on("click",l.externalClickListener),angular.element(document).on("keydown",l.keyboardListener),l.getFormElements(),l.tabIndex=0;var r=angular.element(n[0].querySelector(".helperContainer"))[0];if("undefined"!=typeof r){for(var o=0;o<r.getElementsByTagName("BUTTON").length;o++)a[o]=r.getElementsByTagName("BUTTON")[o];d=a.length+r.getElementsByTagName("INPUT").length}n[0].querySelector(".inputFilter")?(n[0].querySelector(".inputFilter").focus(),l.tabIndex=l.tabIndex+d-2):u[l.tabIndex].focus(),l.onOpen()}},l.externalClickListener=function(e){for(var r=n.find(e.target.tagName),o=0;o<r.length;o++)if(e.target==r[o])return;angular.element(s.previousSibling).removeClass("buttonClicked"),angular.element(s).removeClass("show"),angular.element(document).off("click",l.externalClickListener),angular.element(document).off("keydown",l.keyboardListener),t(function(){l.onClose()},0),n.children().children()[0].focus()},l.select=function(e,t){var n=a.indexOf(t.target);switch(l.tabIndex=n,e.toUpperCase()){case"ALL":angular.forEach(l.filteredModel,function(e){"undefined"!=typeof e&&e[l.disableProperty]!==!0&&"undefined"==typeof e[l.groupProperty]&&(e[l.tickProperty]=!0)}),l.refreshOutputModel(),l.refreshButton(),l.onSelectAll();break;case"NONE":angular.forEach(l.filteredModel,function(e){"undefined"!=typeof e&&e[l.disableProperty]!==!0&&"undefined"==typeof e[l.groupProperty]&&(e[l.tickProperty]=!1)}),l.refreshOutputModel(),l.refreshButton(),l.onSelectNone();break;case"RESET":angular.forEach(l.filteredModel,function(e){if("undefined"==typeof e[l.groupProperty]&&"undefined"!=typeof e&&e[l.disableProperty]!==!0){var t=e[l.indexProperty];e[l.tickProperty]=l.backUp[t][l.tickProperty]}}),l.refreshOutputModel(),l.refreshButton(),l.onReset();break;case"CLEAR":l.tabIndex=l.tabIndex+1,l.onClear();break;case"FILTER":l.tabIndex=a.length-1}},l.prepareGrouping=function(){var e=0;angular.forEach(l.filteredModel,function(t){t[l.spacingProperty]=e,t[l.groupProperty]===!0?e+=2:t[l.groupProperty]===!1&&(e-=2)})},l.prepareIndex=function(){var e=0;angular.forEach(l.filteredModel,function(t){t[l.indexProperty]=e,e++})},l.keyboardListener=function(e){var t=e.keyCode?e.keyCode:e.which,n=!1;if(27===t)e.preventDefault(),l.toggleCheckboxes(e);else if(40===t||39===t||!e.shiftKey&&9==t)for(n=!0,i=l.tabIndex,l.tabIndex++,l.tabIndex>u.length-1&&(l.tabIndex=0,i=u.length-1);u[l.tabIndex].disabled===!0;)l.tabIndex++,l.tabIndex>u.length-1&&(l.tabIndex=0);else if(38===t||37===t||e.shiftKey&&9==t)for(n=!0,i=l.tabIndex,l.tabIndex--,l.tabIndex<0&&(l.tabIndex=u.length-1,i=0);u[l.tabIndex].disabled===!0;)l.tabIndex--,l.tabIndex<0&&(l.tabIndex=u.length-1);if(n===!0){e.preventDefault(),u[l.tabIndex].focus();var r=document.activeElement;"CHECKBOX"===r.type.toUpperCase()?(l.setFocusStyle(l.tabIndex),l.removeFocusStyle(i)):(l.removeFocusStyle(i),l.removeFocusStyle(d),l.removeFocusStyle(u.length-1))}n=!1},l.setFocusStyle=function(e){angular.element(u[e]).parent().parent().parent().addClass("multiSelectFocus")},l.removeFocusStyle=function(e){angular.element(u[e]).parent().parent().parent().removeClass("multiSelectFocus")};var g=o(5);if(l.indexProperty="idx_"+g,l.spacingProperty="spc_"+g,"undefined"!=typeof r.orientation&&("HORIZONTAL"===r.orientation.toUpperCase()?(l.orientationH=!0,l.orientationV=!1):(l.orientationH=!1,l.orientationV=!0)),s=n.children().children().next()[0],"undefined"!=typeof r.maxHeight){var y=n.children().children().children()[0];angular.element(y).attr("style","height:"+l.maxHeight+"; overflow-y:scroll;")}var h={};h.selectAll="&#10003;",h.selectNone="&times;",h.reset="&#8630;","undefined"!=typeof r.translation?(l.lang.selectAll=e.trustAsHtml(h.selectAll+"&nbsp;&nbsp;"+l.translation.selectAll),l.lang.selectNone=e.trustAsHtml(h.selectNone+"&nbsp;&nbsp;"+l.translation.selectNone),l.lang.reset=e.trustAsHtml(h.reset+"&nbsp;&nbsp;"+l.translation.reset),l.lang.search=l.translation.search,l.lang.nothingSelected=e.trustAsHtml(l.translation.nothingSelected)):(l.lang.selectAll=e.trustAsHtml(h.selectAll+"&nbsp;&nbsp;Select All"),l.lang.selectNone=e.trustAsHtml(h.selectNone+"&nbsp;&nbsp;Select None"),l.lang.reset=e.trustAsHtml(h.reset+"&nbsp;&nbsp;Reset"),l.lang.search="Search...",l.lang.nothingSelected="None Selected"),"undefined"!=typeof r.MinSearchLength&&parseInt(r.MinSearchLength)>0&&(c=Math.floor(parseInt(r.MinSearchLength))),l.$watch("inputModel",function(e){e&&(l.localModel=angular.copy(l.inputModel),l.refreshOutputModel(),l.refreshButton())},!0),l.$watch("localModel",function(e){e&&(l.backUp=angular.copy(l.localModel),l.updateFilter(),l.prepareGrouping(),l.prepareIndex(),l.refreshOutputModel(),l.refreshButton())}),l.$watch("isDisabled",function(e){l.isDisabled=e}),angular.element(document).on("touchstart",function(){l.$apply(function(){p=!1})}),angular.element(document).on("touchmove",function(){l.$apply(function(){p=!0})})}}}]).run(["$templateCache",function(e){var t='<span class="multiSelect inlineBlock" id={{directiveId}}><button type="button"ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"ng-bind-html="varButtonLabel"></button><div class="checkboxLayer"><div class="helperContainer" ng-if="displayHelper( \'filter\' ) || displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><div class="line" ng-if="displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><button type="button" class="helperButton"ng-if="!isDisabled && displayHelper( \'all\' )"ng-click="select( \'all\', $event );"ng-bind-html="lang.selectAll"></button><button type="button" class="helperButton"ng-if="!isDisabled && displayHelper( \'none\' )"ng-click="select( \'none\', $event );"ng-bind-html="lang.selectNone"></button><button type="button" class="helperButton reset"ng-if="!isDisabled && displayHelper( \'reset\' )"ng-click="select( \'reset\', $event );"ng-bind-html="lang.reset"></button></div><div class="line" style="position:relative" ng-if="displayHelper( \'filter\' )"><input placeholder="{{lang.search}}" type="text"ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="searchChanged()" class="inputFilter"/><button type="button" class="clearButton" ng-click="clearClicked( $event )" >×</button> </div> </div> <div class="checkBoxContainer"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );" ng-mouseleave="removeFocusStyle( tabIndex );"> <div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index"></div>  <div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div><span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true">✔</span></div></div></div></span>';e.put("isteven-multi-select.htm",t)}]);