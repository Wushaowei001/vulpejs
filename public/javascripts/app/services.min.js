"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(o,e){var t="undefined"==typeof window.localStorage?void 0:window.localStorage,r=!("undefined"==typeof t||"undefined"==typeof window.JSON),s={parseValue:function(o){var e;try{e=JSON.parse(o),"undefined"==typeof e&&(e=o),"true"==e&&(e=!0),"false"==e&&(e=!1),parseFloat(e)!=e||angular.isObject(e)||(e=parseFloat(e))}catch(t){e=o}return e}},n={set:function(o,n){if(!r)try{return e.set(o,n),n}catch(c){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var i=JSON.stringify(n);return t.setItem(o,i),s.parseValue(i)},get:function(o){if(!r)try{return s.parseValue(e.get(o))}catch(n){return null}var c=t.getItem(o);return s.parseValue(c)},remove:function(o){if(!r)try{return e.remove(o),!0}catch(s){return!1}return t.removeItem(o),!0},bind:function(e,t,r){return r=r||"",n.get(t)||n.set(t,r),o(t).assign(e,n.get(t)),e.$watch(t,function(o){n.set(t,o)},!0),n.get(t)}};return n}]),app.factory("$authenticator",["$rootScope","$store",function(o,e){return o.userDetails={},{userDetails:function(){return o.userDetails=JSON.parse(e.get("userDetails")),o.userDetails},loginSuccessfully:function(t){o.userDetails=t,e.set("userDetails",JSON.stringify(o.userDetails))},updateUserDetails:function(){e.set("userDetails",JSON.stringify(o.userDetails))},logoutSuccessfully:function(){this.userIsAuthenticated=!1,e.remove("userDetails"),e.remove("userIsAuthenticated")}}}]),app.factory("$messages",["$rootScope",function(o){return{type:"",message:"",addMessage:function(o,e){this.type=o,this.message=e,this.broadcastMessage()},addErrorMessage:function(o){this.type="danger",this.message=o,this.broadcastMessage()},addInfoMessage:function(o){this.type="info",this.message=o,this.broadcastMessage()},addWarningMessage:function(o){this.type="warning",this.message=o,this.broadcastMessage()},addSuccessMessage:function(o){this.type="success",this.message=o,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){o.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){o.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("AppManager",["$rootScope","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store",function($rootScope,$http,$authenticator,$messages,$dialogs,$timeout,i18n,$store){$rootScope.onlyNumbers=/^\d+$/,$rootScope.showing=!1,$rootScope.form={},$rootScope.name="",$rootScope.listUrl="",$rootScope.predicate="",$rootScope.reverse=!0,$rootScope.item={},$rootScope.items=[],$rootScope.history=[],$rootScope.historyItems=[],$rootScope.historyVersion=null,$rootScope.saveType="",$rootScope.selectedTab=0;var nothing=function(){},empty=function(){return""};$rootScope.newItem=nothing,$rootScope.focus=nothing,$rootScope.hotkeys=nothing,$rootScope.listFilter=function(o){return o.filter.status?"/status/"+o.filter.status:""},$rootScope.listBefore=nothing,$rootScope.listAfter=nothing,$rootScope.validate=nothing,$rootScope.createBefore=nothing,$rootScope.createAfter=nothing,$rootScope.findBefore=nothing,$rootScope.findAfter=nothing,$rootScope.saveBefore=nothing,$rootScope.saveAfter=nothing,$rootScope.cancelBefore=nothing,$rootScope.cancelAfter=nothing,$rootScope.removeBefore=function(o,e){e()},$rootScope.removeAfter=nothing,$rootScope.loadArrays=[],$rootScope.loadProperties=[];var loadProperties=function(){$rootScope.loadProperties.length>0&&$rootScope.loadProperties.forEach(function(o){$rootScope.loadProperty(o)})};$rootScope.errorHandler={},$rootScope.filter={status:""};var service=function(o){$rootScope.name=o.name,$rootScope.listUrl=o.listUrl?o.listUrl:"/"+o.name+"s",o.predicate&&($rootScope.predicate=o.predicate),o.focus&&($rootScope.focus=function(){$("#"+o.name+"-"+o.focus).focus()}),$rootScope.hotkeys=o.hotkeys||nothing,o.list&&(o.list.filter&&($rootScope.listFilter=o.list.filter),$rootScope.listBefore=o.list.before||nothing,$rootScope.listAfter=o.list.after||nothing),o.actions&&($rootScope.newItem=o.actions.newItem||nothing,o.actions.focus&&($rootScope.focus=o.actions.focus),$rootScope.validate=o.actions.validate||nothing,$rootScope.createBefore=o.actions.createBefore||nothing,$rootScope.createAfter=o.actions.createAfter||nothing,$rootScope.findBefore=o.actions.findBefore||nothing,$rootScope.findAfter=o.actions.findAfter||nothing,$rootScope.saveBefore=o.actions.saveBefore||nothing,$rootScope.saveAfter=o.actions.saveAfter||nothing,$rootScope.removeBefore=o.actions.removeBefore||nothing,$rootScope.removeAfter=o.actions.removeAfter||nothing,$rootScope.cancelBefore=o.actions.cancelBefore||nothing,$rootScope.cancelAfter=o.actions.cancelAfter||nothing),o.load&&($rootScope.loadArrays=o.load.arrays||[],$rootScope.loadProperties=o.load.properties||[]),o.error&&($rootScope.errorHandler=o.error.handle||nothing)},options={$rootScope:$rootScope,$store:$store};$rootScope.currentPage=0,$rootScope.pageSize=1,$rootScope.historyCurrentPage=0,$rootScope.historyPageSize=1,$rootScope.prevPage=function(o){$messages.cleanAllMessages(),o?$rootScope.historyCurrentPage>0&&($rootScope.historyCurrentPage--,$rootScope.historyList($rootScope.historyCurrentPage),$rootScope.historyVersion=null):$rootScope.currentPage>0&&($rootScope.currentPage--,$rootScope.list($rootScope.currentPage))},$rootScope.nextPage=function(o){$messages.cleanAllMessages(),o?$rootScope.historyCurrentPage<$rootScope.historyPageSize-1&&($rootScope.historyCurrentPage++,$rootScope.historyList($rootScope.historyCurrentPage+1),$rootScope.historyVersion=null):$rootScope.currentPage<$rootScope.pageSize-1&&($rootScope.currentPage++,$rootScope.list($rootScope.currentPage+1))},$rootScope.setPage=function(o){o?($messages.cleanAllMessages(),$rootScope.historyCurrentPage=this.n,$rootScope.historyList($rootScope.historyCurrentPage+1),$rootScope.historyVersion=null):($messages.cleanAllMessages(),$rootScope.currentPage=this.n,$rootScope.list($rootScope.currentPage+1))},$rootScope.range=function(o,e){var t=[];e||(e=o,o=0);for(var r=o;e>r;r++)t.push(r);return t};var errorHandler=function(o,e,t,r,s){angular.isFunction($rootScope.errorHandler)?$rootScope.errorHandler({operation:o,data:e,status:t,header:r,config:s,messages:$messages}):$messages.addErrorMessage("An error occurred in the execution.")};$rootScope.create=function(){$rootScope.createBefore(options),$rootScope.item=$rootScope.newItem(options),$rootScope.showing=!0,clearHistory(),$timeout(function(){$rootScope.focus()},100),$rootScope.createAfter(options)};var clearHistory=function(){$rootScope.history=[],$rootScope.historyItems=[],$rootScope.historyVersion=null};$rootScope.cancel=function(){$rootScope.cancelBefore(options),$rootScope.item=$rootScope.newItem(options),$rootScope.showing=!1,clearHistory(),$rootScope.cancelAfter(options)},$rootScope.historyCopy=function(){var o=angular.isObject($rootScope.historyVersion);if($rootScope.form.historySelected.$setValidity("historyNotSelected",o),o){var e=$rootScope.item.version;$rootScope.item=$rootScope.historyVersion,e&&($rootScope.item.version=e)}},$rootScope.list=function(o){o||(o=1,$rootScope.currentPage=0),$rootScope.listBefore(options);var e=$rootScope.listFilter({filter:$rootScope.filter});e+="/page/"+o,$http.get(vulpe.ng.rootContext+$rootScope.listUrl+e).success(function(o){$rootScope.items=o.items,$rootScope.pageSize=o.pageCount,$rootScope.listAfter(options)})},$rootScope.historyList=function(o){clearHistory(),o||(o=1),$http.get(vulpe.ng.rootContext+$rootScope.name+"/history/"+$rootScope.item._id+"/page/"+o).success(function(o){$rootScope.history=o.items,0!==$rootScope.history.length&&($rootScope.historyPageSize=o.pageCount,angular.forEach($rootScope.history,function(o){$rootScope.historyItems.push(JSON.parse(o.content))}))})},$rootScope.find=function(o){$rootScope.findBefore(options),$http.get(vulpe.ng.rootContext+"/"+$rootScope.name+"/"+o).success(function(o){$rootScope.item=o.item,$rootScope.showing=!$rootScope.showing,$rootScope.history=o.history.items,0!==$rootScope.history.length&&($rootScope.historyPageSize=o.history.pageCount,angular.forEach($rootScope.history,function(o){$rootScope.historyItems.push(JSON.parse(o.content))})),$rootScope.findAfter(options),loadProperties(),$timeout(function(){$rootScope.focus()},100)})},$rootScope.remove=function(o){var e=function(){$messages.cleanAllMessages(),$rootScope.removeBefore(o,function(){$http({method:"DELETE",url:"/"+$rootScope.name+"/"+o}).success(function(){$rootScope.list(),$messages.addSuccessMessage("Operation successfully executed!"),$rootScope.removeAfter(options)}).error(function(o,e,t,r){errorHandler("REMOVE",o,e,t,r)})})};$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){e()},function(){})},$rootScope.removeFromArray=function(o,e,t){var r=$rootScope.$eval("item."+o),s=function(){$messages.cleanAllMessages(),r.splice(t,1)},n=$rootScope.$eval("item."+o+"["+t+"]."+e);n?$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){s()},function(){}):s()},$rootScope.addToArray=function(o,e){$messages.cleanAllMessages();var t=$rootScope.$eval("item."+o);t.push(e)};var addJSONValue=function(o,e,t){var r=JSON.stringify(o);return r=r.substring(0,r.length-1)+', "'+e+'":"'+t+'"}',JSON.parse(o)};return $rootScope.save=function(o){if($rootScope.form.$valid)if(o)$rootScope.saveType=o;else{$rootScope.saveBefore(options),$messages.cleanAllMessages();var e=$authenticator.userDetails();$rootScope.item.user=e.id,$http.post(vulpe.ng.rootContext+"/"+$rootScope.name,$rootScope.item).success(function(o){$rootScope.item=o.item,$rootScope.saveType.length>0&&("NEW"===$rootScope.saveType?$rootScope.create():"CLOSE"===$rootScope.saveType&&($rootScope.create(),$rootScope.showing=!1),$rootScope.saveType=""),$messages.addSuccessMessage("Operation successfully executed!"),$timeout(function(){$rootScope.list(),$rootScope.focus()},100),$rootScope.saveAfter(options),loadProperties()}).error(function(o,e,t,r){errorHandler("SAVE",o,e,t,r)})}},$rootScope.status=function(o,e){$messages.cleanAllMessages(),$http.post(vulpe.ng.rootContext+"/"+$rootScope.name+"/status",{id:o,status:e}).success(function(){$messages.addSuccessMessage("Status successfully changed!"),$timeout(function(){$rootScope.list($rootScope.currentPage+1),$rootScope.focus()},100)}).error(function(o,e,t,r){errorHandler("STATUS",o,e,t,r)})},$rootScope.datepicker=function(o){o.preventDefault(),o.stopPropagation(),$rootScope.datepickerOpened=!$rootScope.datepickerOpened},$rootScope.inputFocus=function(o){var e="input[name='"+o+"']",t=$(e).filter(function(){return""==this.value});t.length>0?$(t.get(0)).focus():$(e).focus()},$rootScope.nextTab=function(){$rootScope.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab+1)).find("a").trigger("click")},$rootScope.previousTab=function(){$rootScope.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab-1)).find("a").trigger("click")},$rootScope.tabsHotkeys=function(){$(document).bind("keydown.left",function(){return $rootScope.previousTab(),!1}).bind("keydown.right",function(){return $rootScope.nextTab(),!1})},$rootScope.focusTo=function(o){$(0!==o.indexOf("#")?"#"+o:o).focus()},$rootScope.checkUncheckAll=function(o){$rootScope.selectAll=!$rootScope.selectAll,angular.forEach($rootScope[o],function(o){o.selected=$rootScope.selectAll})},$rootScope.hasRoles=function(o){for(var e=$authenticator.userDetails(),t=0;t<o.length;t++){var r=o[t];if(e.managerType===r)return!0}return!1},$rootScope.equals=function(o,e,t){return o?o[e]===t:!1},$rootScope.typeaheadOnSelect=function(o,e,t){$rootScope.item[o]=e[t]},$rootScope.loadArray=function(o){var e=o.from,t=o.name,r=o.label;$rootScope[t]=[],$http.get(e).success(function(o){$rootScope[t]=o.items,r&&angular.forEach($rootScope[t],function(o){o.label="";var e=[],t=" - ";angular.isArray(r)?e=r:angular.isObject(r)&&(e=r.properties,t=r.separator),e.forEach(function(e){o.label.length>0&&(o.label+=t),o.label+=o[e]})})})},$rootScope.loadProperty=function(options){var from=options.from,to=options.to,when=options.when,fromParts=from.split("."),fromProperty=fromParts.splice(1,fromParts.length);from=null;var toParts=to.split("."),toProperty=toParts.splice(1,toParts.length);if(to=null,fromParts.forEach(function(o){from=null===from?$rootScope[o]:from[o]}),toParts.forEach(function(o){to=null===to?$rootScope[o]:to[o]}),angular.isArray(from))for(var array=from,i=0;i<array.length;i++)if(from=array[i],eval(when)){to[toProperty]=from[fromProperty];break}},service.prototype.init=function(){$authenticator.userDetails(),$rootScope.item=$rootScope.newItem(options),$rootScope.validate(),$rootScope.list(),$rootScope.loadArrays.length>0&&angular.forEach($rootScope.loadArrays,function(o){$rootScope.loadArray(o)}),$rootScope.hotkeys(),$rootScope.tabsHotkeys(),$rootScope.focus()},service}]);