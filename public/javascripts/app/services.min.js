"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(e,s){var t="undefined"==typeof window.localStorage?void 0:window.localStorage,o=!("undefined"==typeof t||"undefined"==typeof window.JSON),r={parseValue:function(e){var s;try{s=JSON.parse(e),"undefined"==typeof s&&(s=e),"true"==s&&(s=!0),"false"==s&&(s=!1),parseFloat(s)!=s||angular.isObject(s)||(s=parseFloat(s))}catch(t){s=e}return s}},n={set:function(e,n){if(!o)try{return s.set(e,n),n}catch(i){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var a=JSON.stringify(n);return t.setItem(e,a),r.parseValue(a)},get:function(e){if(!o)try{return r.parseValue(s.get(e))}catch(n){return null}var i=t.getItem(e);return r.parseValue(i)},remove:function(e){if(!o)try{return s.remove(e),!0}catch(r){return!1}return t.removeItem(e),!0},bind:function(s,t,o){return o=o||"",n.get(t)||n.set(t,o),e(t).assign(s,n.get(t)),s.$watch(t,function(e){n.set(t,e)},!0),n.get(t)}};return n}]),app.factory("$authenticator",["$rootScope","$store",function(e,s){return e.vulpejs={userDetails:{}},{userDetails:function(){return e.vulpejs.userDetails=s.get("userDetails"),e.vulpejs.userDetails},loginSuccessfully:function(t){e.vulpejs.userDetails=t,s.set("userDetails",e.vulpejs.userDetails)},updateUserDetails:function(){s.set("userDetails",e.vulpejs.userDetails)},logoutSuccessfully:function(){this.userIsAuthenticated=!1,s.remove("userDetails"),s.remove("userIsAuthenticated"),application&&application.login&&application.login.arrays&&application.login.arrays.forEach(function(e){s.remove(e)})}}}]),app.factory("$messages",["$rootScope",function(e){return{type:"",message:"",addMessage:function(e,s){this.type=e,this.message=s,this.broadcastMessage()},addErrorMessage:function(e){this.type="danger",this.message=e,this.broadcastMessage()},addInfoMessage:function(e){this.type="info",this.message=e,this.broadcastMessage()},addWarningMessage:function(e){this.type="warning",this.message=e,this.broadcastMessage()},addSuccessMessage:function(e){this.type="success",this.message=e,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){e.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){e.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("VulpeJS",["$rootScope","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store","$cookieStore","$sce",function($rootScope,$http,$authenticator,$messages,$dialogs,$timeout,i18n,$store,$cookieStore,$sce){var nothing=function(){},empty=function(){return""},vulpejs={$store:$store,$authenticator:$authenticator,$http:$http,$messages:$messages,$dialogs:$dialogs,$timeout:$timeout,$broadcast:$rootScope.$broadcast,i18n:i18n,addErrorMessage:function(e){$messages.addErrorMessage(e)},addInfoMessage:function(e){$messages.addInfoMessage(e)},addWarningMessage:function(e){$messages.addWarningMessage(e)},addSuccessMessage:function(e){$messages.addSuccessMessage(e)},cleanAllMessages:function(){$messages.cleanAllMessages()},rootContext:vulpe.ng.rootContext,onlyNumbers:/^\d+$/,showing:!1,form:{},name:"",listUrl:"",predicate:"",reverse:!0,populate:!1,item:{},items:[],history:[],historyItems:[],historyVersion:null,saveType:"",selectedTab:0,messages:{validate:{save:{exists:"This record already exists."},remove:{exists:"This record is being used by another registry and can not be deleted."}}},newItem:nothing,focus:nothing,hotkeys:nothing,listFilter:function(e){return e.filter.status?"/status/"+e.filter.status:""},listBefore:nothing,listAfter:nothing,validate:nothing,createBefore:nothing,createAfter:nothing,findBefore:nothing,findAfter:nothing,saveBefore:nothing,saveAfter:nothing,cancelBefore:nothing,cancelAfter:nothing,statusBefore:nothing,statusAfter:nothing,removeBefore:function(e,s){s()},removeAfter:nothing,loadArrays:[],loadProperties:[],doLoadProperties:function(){vulpejs.loadProperties.length>0&&vulpejs.loadProperties.forEach(function(e){vulpejs.loadProperty(e)})},init:nothing,errorHandler:{},filter:{status:""},doDebug:function(e){vulpejs.debug&&console.debug(e)},pageSize:15,totalItems:0,pageChangeHandler:function(e){$messages.cleanAllMessages(),vulpejs.list(e)},historyPageChangeHandler:function(e){$messages.cleanAllMessages(),vulpejs.historyList(e),vulpejs.historyVersion=null},trustSrc:function(e){return $sce.trustAsResourceUrl(e)},expressionEval:function(e){var s=e;if(/\{(.*)\}/.test(e)){var t=e.match(/\{(.*)\}/),o=t[1].split(":");s=s.replace(t[0],"");var r="";if(o.length>1)if(-1!==o[1].indexOf(".")){var n=o[1].split(".");r="store"===o[0]?$store.get(n[0])?$store.get(n[0])[n[1]]:"":$rootScope.vulpejs[n[0]]?$rootScope.vulpejs[n[0]][n[1]]:""}else r="store"===o[0]?$store.get(o[1])?$store.get(o[1]):"":$rootScope.vulpejs[o[1]]?$rootScope.vulpejs[o[1]]:"";else if(-1!==o[0].indexOf(".")){var n=o[0].split(".");r=$rootScope.vulpejs[n[0]][n[1]]}else r=$rootScope.vulpejs[o[0]];0===r.length?s="":s+=r}return s},propertiesEval:function(e){if(angular.isObject(e))for(var s in e)angular.isArray(e[s])?e[s].forEach(function(e){e=vulpejs.propertiesEval(e)}):e[s]=angular.isObject(e[s])?vulpejs.propertiesEval(e[s]):vulpejs.expressionEval(e[s]);return e},create:function(){vulpejs.createBefore(vulpejs),vulpejs.doDebug({type:"CREATE-BEFORE",item:vulpejs.item}),clearItem(!0),$timeout(function(){vulpejs.focus()},100),vulpejs.createAfter(vulpejs),vulpejs.doDebug({type:"CREATE-AFTER",item:vulpejs.item})},cancel:function(){vulpejs.cancelBefore(vulpejs),vulpejs.doDebug({type:"CANCEl-BEFORE",item:vulpejs.item}),clearItem(!1),vulpejs.cancelAfter(vulpejs),vulpejs.doDebug({type:"CANCEl-AFTER",item:vulpejs.item})},historyCopy:function(){var e=angular.isObject(vulpejs.historyVersion);if($rootScope.form.historySelected.$setValidity("historyNotSelected",e),e){var s=vulpejs.item.version;vulpejs.item=vulpejs.historyVersion,s&&(vulpejs.item.version=s)}},list:function(e){e||(e=1,vulpejs.currentPage=0),vulpejs.listBefore(vulpejs),vulpejs.doDebug({type:"LIST-BEFORE",items:vulpejs.items});var s=vulpejs.listFilter(vulpejs);s+="/page/"+e,$http.get(vulpejs.rootContext+vulpejs.listUrl+s).success(function(e){vulpejs.items=e.items,$rootScope.totalItems=e.pageCount*$rootScope.pageSize,vulpejs.listAfter(vulpejs),vulpejs.doDebug({type:"LIST-AFTER",items:vulpejs.items})})},historyList:function(e){clearHistory(),e||(e=1),$http.get(vulpejs.rootContext+vulpejs.name+"/history/"+vulpejs.item._id+"/page/"+e).success(function(e){vulpejs.history=e.items,0!==vulpejs.history.length&&(vulpejs.historyPageSize=e.pageCount,angular.forEach(vulpejs.history,function(e){vulpejs.historyItems.push(JSON.parse(e.content))}))})},find:function(e){vulpejs.findBefore(vulpejs),vulpejs.doDebug({type:"FIND-BEFORE",item:vulpejs.item}),$http.get(vulpejs.rootContext+"/"+vulpejs.name+($rootScope.populate?"/populate":"")+"/"+e).success(function(e){vulpejs.item=e.item,vulpejs.showing=!vulpejs.showing,vulpejs.history=e.history.items,0!==vulpejs.history.length&&(vulpejs.historyPageSize=e.history.pageCount,angular.forEach(vulpejs.history,function(e){vulpejs.historyItems.push(JSON.parse(e.content))})),vulpejs.findAfter(vulpejs),vulpejs.doDebug({type:"FIND-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties(),$timeout(function(){vulpejs.focus()},100)})},close:function(e){vulpejs.closeBefore(vulpejs),vulpejs.doDebug({type:"CLONE-BEFORE",item:vulpejs.item}),vulpejs.item=angular.copy(e),delete vulpejs.item._id,vulpejs.showing=!0,clearHistory(),vulpejs.closeAfter(vulpejs),vulpejs.doDebug({type:"CLONE-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties(),$timeout(function(){vulpejs.focus()},100)},remove:function(e){vulpejs.operation="REMOVE";var s=function(){$messages.cleanAllMessages(),vulpejs.removeBefore(e,function(){$http({method:"DELETE",url:"/"+vulpejs.name+"/"+e}).success(function(){clearItem(!1),vulpejs.list(),$messages.addSuccessMessage("Record successfully deleted!"),vulpejs.removeAfter(vulpejs)}).error(httpErrorHandler)})};$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){s()},function(){})},removeFromArray:function(e,s,t){var o=function(){$messages.cleanAllMessages(),vulpejs.item[e].splice(t,1)},r=vulpejs.item[e][t][s];r?$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){o()},function(){}):o()},addToArray:function(e,s){$messages.cleanAllMessages(),vulpejs.item[e].push(s)},save:function(e){$rootScope.form.$valid&&(e?vulpejs.saveType=e:(vulpejs.item._id&&(vulpejs.isUpdate=!0),vulpejs.isValid=!0,vulpejs.operation="SAVE",vulpejs.saveBefore(vulpejs),vulpejs.isValid&&(vulpejs.doDebug({type:"SAVE-BEFORE",item:vulpejs.item}),$messages.cleanAllMessages(),$http.post(vulpejs.rootContext+"/"+vulpejs.name,vulpejs.item).success(function(e){vulpejs.item=e.item,vulpejs.saveType.length>0&&("NEW"===vulpejs.saveType?vulpejs.create():"CLOSE"===vulpejs.saveType&&(vulpejs.create(),vulpejs.showing=!1),vulpejs.saveType=""),$messages.addSuccessMessage("Record successfully saved!"),$timeout(function(){vulpejs.list(),vulpejs.focus()},100),vulpejs.saveAfter(vulpejs),vulpejs.doDebug({type:"SAVE-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties()}).error(httpErrorHandler))))},status:function(e,s){vulpejs.operation="STATUS",$messages.cleanAllMessages(),vulpejs.statusBefore(vulpejs),$http.post(vulpejs.rootContext+"/"+vulpejs.name+"/status",{id:e,status:s}).success(function(){vulpejs.item._id&&(vulpejs.item.status=s),$messages.addSuccessMessage("Status successfully changed!"),vulpejs.statusAfter(vulpejs),$timeout(function(){vulpejs.list($rootScope.currentPage+1),vulpejs.focus()},100)}).error(httpErrorHandler)},datepicker:function(e){e.preventDefault(),e.stopPropagation(),vulpejs.datepickerOpened=!vulpejs.datepickerOpened},inputFocus:function(e){var s="input[name='"+e+"']",t=$(s).filter(function(){return""==this.value});t.length>0?$(t.get(0)).focus():$(s).focus()},tabNext:function(){vulpejs.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab+1)).find("a").trigger("click")},tabPrevious:function(){vulpejs.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab-1)).find("a").trigger("click")},tabFocus:function(e){e&&e.length>0&&$timeout(function(){vulpejs.focusTo(vulpejs.name+"-"+e)},100)},tabsHotkeys:function(){$(document).bind("keydown.left",function(){return vulpejs.tabPrevious(),!1}).bind("keydown.right",function(){return vulpejs.tabNext(),!1})},focusTo:function(e){$(0!==e.indexOf("#")?"#"+e:e).focus()},checkUncheckAll:function(e){$rootScope.selectAll=!$rootScope.selectAll,angular.forEach($rootScope[e],function(e){e.selected=$rootScope.selectAll})},hasRoles:function(e){for(var s=$authenticator.userDetails(),t=0;t<e.length;t++){var o=e[t];if(-1!==s.roles.indexOf(o))return!0}return!1},equals:function(e,s,t){return e?e[s]===t:!1},typeaheadOnSelect:function(e,s,t){vulpejs.item[e]=s[t]},selectOnChange:function(e,s,t){"undefined"!=typeof vulpejs.item[e]&&$rootScope.vulpejs[s].forEach(function(s){s[t]===vulpejs.item[e]&&($rootScope.vulpejs[e]=s)})},loadArray:function(e){var s=e.from,t=e.to,o=e.label;$rootScope.vulpejs[t]=[],s=vulpejs.expressionEval(s),s.length>0&&$http.get(s).success(function(e){$rootScope.vulpejs[t]=e.items,o&&angular.forEach($rootScope.vulpejs[t],function(e){if(e.label="",angular.isString(o))e.label+=e[o];else{var s=[],t=" - ";angular.isArray(o)?s=o:angular.isObject(o)&&(s=o.properties,t=o.separator),s.forEach(function(s){e.label.length>0&&(e.label+=t),e.label+=e[s]})}})})},loadProperty:function(options){var from=options.from,to=options.to,when=options.when,fromParts=from.split("."),fromProperty=fromParts.pop();from=null;var toParts=to.split("."),toProperty=toParts.pop();if(to=null,fromParts.forEach(function(e){from=null===from?$rootScope.vulpejs[e]:from[e]}),toParts.forEach(function(e){to=null===to?$rootScope.vulpejs[e]:to[e]}),angular.isArray(from))for(var array=from,i=0;i<array.length;i++)if(from=array[i],eval(when)){to[toProperty]=from[fromProperty];break}},flowFilesSubmit:function(e){e.upload()}};if(vulpejs.debug=$cookieStore.get("debug")||vulpejs.debug,window.location.search){var search=window.location.search.substring(1),status=function(e){var s=e.split("=");"status"===s[0]&&(vulpejs.filter.status=s[1])};-1!==search.indexOf("&")?search.split("&").forEach(function(e){-1!==e.indexOf("status=")&&status(e)}):status(search)}var service=function(e){vulpejs.debug=e.debug||!1,vulpejs.name=e.name,vulpejs.listUrl=e.listUrl||"/"+e.name+"s",vulpejs.predicate=e.predicate||"",e.populate&&(vulpejs.populate=e.populate),e.focus&&(vulpejs.focus=function(){if(angular.isFunction(e.focus))e.focus(vulpejs);else{var s="#"+e.name.replace(/\-/g,"")+"-";angular.isObject(e.focus)?$(s+(vulpejs.item._id?e.focus.edit:e.focus.new)).focus():$(s+e.focus).focus()}}),e.messages&&(vulpejs.messages=e.messages),vulpejs.hotkeys=e.hotkeys||nothing,e.list&&(e.list.filter&&(vulpejs.listFilter=e.list.filter),vulpejs.listBefore=e.list.before||nothing,vulpejs.listAfter=e.list.after||nothing),e.actions&&(vulpejs.newItem=e.actions.newItem||nothing,e.actions.focus&&(vulpejs.focus=e.actions.focus),vulpejs.validate=e.actions.validate||nothing,vulpejs.createBefore=e.actions.createBefore||nothing,vulpejs.createAfter=e.actions.createAfter||nothing,vulpejs.cloneBefore=e.actions.cloneBefore||nothing,vulpejs.cloneAfter=e.actions.cloneAfter||nothing,vulpejs.findBefore=e.actions.findBefore||nothing,vulpejs.findAfter=e.actions.findAfter||nothing,vulpejs.saveBefore=e.actions.saveBefore||nothing,vulpejs.saveAfter=e.actions.saveAfter||nothing,vulpejs.statusBefore=e.actions.statusBefore||nothing,vulpejs.statusAfter=e.actions.statusAfter||nothing,e.actions.removeBefore&&($rootScop.vulpejse.removeBefore=e.actions.removeBefore),vulpejs.removeAfter=e.actions.removeAfter||nothing,vulpejs.cancelBefore=e.actions.cancelBefore||nothing,vulpejs.cancelAfter=e.actions.cancelAfter||nothing),e.load&&(vulpejs.loadArrays=e.load.arrays||[],vulpejs.loadProperties=e.load.properties||[]),e.error&&(vulpejs.errorHandler=e.error.handle||nothing),vulpejs.init=e.init||nothing},httpErrorHandler=function(e,s,t,o){angular.isFunction($rootScope.errorHandler)?vulpejs.errorHandler({operation:vulpejs.operation,data:e,status:s,header:t,config:o,$messages:$messages}):e.validate?e.validate.exists&&("SAVE"===vulpejs.operation?$messages.addInfoMessage(vulpejs.messages.validate.save.exists):"REMOVE"===vulpejs.operation&&$messages.addInfoMessage(vulpejs.messages.validate.remove.exists)):$messages.addErrorMessage("An error occurred in the execution.")},clearHistory=function(){vulpejs.history=[],vulpejs.historyItems=[],vulpejs.historyVersion=null},clearItem=function(e){vulpejs.item=vulpejs.newItem(vulpejs),vulpejs.item=vulpejs.propertiesEval(vulpejs.item),vulpejs.showing=e,clearHistory()},addJSONValue=function(e,s,t){var o=JSON.stringify(e);return o=o.substring(0,o.length-1)+', "'+s+'":"'+t+'"}',JSON.parse(e)};return service.prototype.init=function(e){$authenticator.userDetails(),vulpejs.init(vulpejs),application.init&&vulpe.util.tryExecute(application.init),e&&$(document).ready(function(){e.mainForm&&($rootScope.form=e.mainForm),e.multiSelectTranslation={selectAll:i18n.__("Select all"),selectNone:i18n.__("Select none"),reset:i18n.__("Reset"),search:i18n.__("Search"),nothingSelected:i18n.__("Nothing is selected")}}),clearItem(!1),vulpejs.validate(),vulpejs.list(),vulpejs.loadArrays.length>0&&angular.forEach(vulpejs.loadArrays,function(e){vulpejs.loadArray(e)}),vulpejs.hotkeys(),vulpejs.tabsHotkeys(),vulpejs.focus()},service.prototype.store=$store,$rootScope.vulpejs=vulpejs,service}]);