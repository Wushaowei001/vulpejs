"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(e,t){var s="undefined"==typeof window.localStorage?void 0:window.localStorage,o=!("undefined"==typeof s||"undefined"==typeof window.JSON),r={parseValue:function(e){var t;try{t=JSON.parse(e),"undefined"==typeof t&&(t=e),"true"==t&&(t=!0),"false"==t&&(t=!1),parseFloat(t)!=t||angular.isObject(t)||(t=parseFloat(t))}catch(s){t=e}return t}},u={set:function(e,u){if(!o)try{return t.set(e,u),u}catch(n){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var l=JSON.stringify(u);return s.setItem(e,l),r.parseValue(l)},get:function(e){if(!o)try{return r.parseValue(t.get(e))}catch(u){return null}var n=s.getItem(e);return r.parseValue(n)},remove:function(e){if(!o)try{return t.remove(e),!0}catch(r){return!1}return s.removeItem(e),!0},bind:function(t,s,o){return o=o||"",u.get(s)||u.set(s,o),e(s).assign(t,u.get(s)),t.$watch(s,function(e){u.set(s,e)},!0),u.get(s)}};return u}]),app.factory("$authenticator",["$rootScope","$store",function(e,t){return e.vulpejs={userDetails:{}},{userDetails:function(){return e.vulpejs.userDetails=t.get("userDetails"),e.vulpejs.userDetails},loginSuccessfully:function(s){e.vulpejs.userDetails=s,t.set("userDetails",e.vulpejs.userDetails)},updateUserDetails:function(){t.set("userDetails",e.vulpejs.userDetails)},logoutSuccessfully:function(){this.userIsAuthenticated=!1,t.remove("userDetails"),t.remove("userIsAuthenticated"),application&&application.login&&application.login.arrays&&application.login.arrays.forEach(function(e){t.remove(e)})}}}]),app.factory("$messages",["$rootScope",function(e){return{type:"",message:"",addMessage:function(e,t){this.type=e,this.message=t,this.broadcastMessage()},addErrorMessage:function(e){this.type="danger",this.message=e,this.broadcastMessage()},addInfoMessage:function(e){this.type="info",this.message=e,this.broadcastMessage()},addWarningMessage:function(e){this.type="warning",this.message=e,this.broadcastMessage()},addSuccessMessage:function(e){this.type="success",this.message=e,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){e.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){e.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("VulpeJS",["$rootScope","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store","$cookieStore","$sce","$window","$filter",function($rootScope,$http,$authenticator,$messages,$dialogs,$timeout,i18n,$store,$cookieStore,$sce,$window,$filter){var nothing=function(){},empty=function(){return""},vulpejs={$store:$store,$authenticator:$authenticator,$timeout:$timeout,$filter:$filter,$window:$window,broadcast:function(e){$rootScope.$broadcast(e)},i18n:function(e){return i18n.__(e)},message:{success:function(e){$messages.addSuccessMessage(e)},error:function(e){$messages.addErrorMessage(e)},info:function(e){$messages.addInfoMessage(e)},warning:function(e){$messages.addWarningMessage(e)},clean:function(){$messages.cleanAllMessages()}},dialog:{confirm:function(e){$dialogs.confirm(vulpejs.i18n("Confirmation"),vulpejs.i18n(e.message)).result.then(function(){vulpe.utils.tryExecute(e.callback)},function(){})}},http:{get:function(e){$http({url:e.url,params:e.params||{}}).success(function(t){e.callback.success?vulpe.utils.tryExecute(e.callback.success,t):vulpe.utils.tryExecute(e.callback,t)}).error(function(t,s,o,r){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:r})})},"delete":function(e){$http({url:e.url,method:"DELETE",params:e.params||{}}).success(function(t){e.callback.success?vulpe.utils.tryExecute(e.callback.success,t):vulpe.utils.tryExecute(e.callback,t)}).error(function(t,s,o,r){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:r})})},post:function(e){$http.post(e.url,e.data).success(function(t){vulpe.utils.tryExecute(e.callback.success,t)}).error(function(t,s,o,r){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:r})})}},rootContext:vulpe.ng.rootContext,onlyNumbers:/^\d+$/,showing:!1,form:{},name:"",listUrl:"",predicate:"",reverse:!0,populate:!1,item:{},oldItem:{},items:[],history:[],historyItems:[],historyVersion:null,saveType:"",selectedTab:0,messages:{validate:{save:{exists:"This record already exists."},remove:{exists:"This record is being used by another registry and can not be deleted."}}},newItem:nothing,focus:nothing,hotkeys:nothing,listFilter:function(e){return e.filter.status?"/status/"+e.filter.status:""},listBefore:nothing,listAfter:nothing,validate:nothing,createBefore:nothing,createAfter:nothing,findBefore:nothing,findAfter:nothing,saveBefore:nothing,saveAfter:nothing,cancelBefore:nothing,cancelAfter:nothing,statusBefore:nothing,statusAfter:nothing,removeBefore:function(e,t){t()},removeAfter:nothing,loadArrays:[],loadProperties:[],doLoadProperties:function(){vulpejs.loadProperties.length>0&&vulpejs.loadProperties.forEach(function(e){vulpejs.loadProperty(e)})},init:nothing,errorHandler:{},filter:{status:""},doDebug:function(e){vulpejs.debug&&console.debug(e)},pageSize:15,totalItems:0,pageChangeHandler:function(e){vulpejs.message.clean(),vulpejs.list(e)},historyPageChangeHandler:function(e){vulpejs.message.clean(),vulpejs.historyList(e),vulpejs.historyVersion=null},trustSrc:function(e){return $sce.trustAsResourceUrl(e)},expressionEval:function(e){var t=e;if(/\{(.*)\}/.test(e)){var s=e.match(/\{(.*)\}/),o=s[1].split(":");t=t.replace(s[0],"");var r="";if(o.length>1)if(-1!==o[1].indexOf(".")){var u=o[1].split(".");r="store"===o[0]?$store.get(u[0])?$store.get(u[0])[u[1]]:"":$rootScope.vulpejs[u[0]]?$rootScope.vulpejs[u[0]][u[1]]:""}else r="store"===o[0]?$store.get(o[1])?$store.get(o[1]):"":$rootScope.vulpejs[o[1]]?$rootScope.vulpejs[o[1]]:"";else if(-1!==o[0].indexOf(".")){var u=o[0].split(".");r=$rootScope.vulpejs[u[0]][u[1]]}else r=$rootScope.vulpejs[o[0]];0===r.length?t="":t+=r}return t},propertiesEval:function(e){if(angular.isObject(e))for(var t in e)angular.isArray(e[t])?e[t].forEach(function(e){e=vulpejs.propertiesEval(e)}):e[t]=angular.isObject(e[t])?vulpejs.propertiesEval(e[t]):vulpejs.expressionEval(e[t]);return e},create:function(){var e=function(){vulpejs.createBefore(vulpejs),vulpejs.doDebug({type:"CREATE-BEFORE",item:vulpejs.item}),clearItem(!0),$timeout(function(){vulpejs.focus()},100),vulpejs.createAfter(vulpejs),vulpejs.doDebug({type:"CREATE-AFTER",item:vulpejs.item})};vulpejs.item._id?vulpejs.dialog.confirm({message:"The changed data will be lost. Do you really want to continue?",callback:function(){e()}}):e()},cancel:function(){var e=function(){vulpejs.cancelBefore(vulpejs),vulpejs.doDebug({type:"CANCEl-BEFORE",item:vulpejs.item}),clearItem(!1),vulpejs.cancelAfter(vulpejs),vulpejs.doDebug({type:"CANCEl-AFTER",item:vulpejs.item})};vulpejs.hasChanged()?vulpejs.dialog.confirm({message:"The changed data will be lost. Do you really want to continue?",callback:function(){e()}}):e()},historyCopy:function(){var e=angular.isObject(vulpejs.historyVersion);if($rootScope.form.historySelected.$setValidity("historyNotSelected",e),e){var t=vulpejs.item.version;vulpejs.item=vulpejs.historyVersion,t&&(vulpejs.item.version=t),vulpejs.oldItem=vulpejs.copy(vulpejs.item)}},list:function(e){e||(e=1,vulpejs.currentPage=0),vulpejs.listBefore(vulpejs),vulpejs.doDebug({type:"LIST-BEFORE",items:vulpejs.items});var t=vulpejs.listFilter(vulpejs);t+="/page/"+e,$http.get(vulpejs.rootContext+vulpejs.listUrl+t).success(function(e){vulpejs.items=e.items,$rootScope.totalItems=e.pageCount*$rootScope.pageSize,vulpejs.listAfter(vulpejs),vulpejs.doDebug({type:"LIST-AFTER",items:vulpejs.items})})},historyList:function(e){clearHistory(),e||(e=1),$http.get(vulpejs.rootContext+vulpejs.name+"/history/"+vulpejs.item._id+"/page/"+e).success(function(e){vulpejs.history=e.items,0!==vulpejs.history.length&&(vulpejs.historyPageSize=e.pageCount,angular.forEach(vulpejs.history,function(e){vulpejs.historyItems.push(JSON.parse(e.content))}))})},find:function(e){vulpejs.findBefore(vulpejs),vulpejs.doDebug({type:"FIND-BEFORE",item:vulpejs.item}),$http.get(vulpejs.rootContext+"/"+vulpejs.name+($rootScope.populate?"/populate":"")+"/"+e).success(function(e){vulpejs.item=e.item,vulpejs.oldItem=vulpejs.copy(vulpejs.item),vulpejs.showing=!vulpejs.showing,vulpejs.history=e.history.items,0!==vulpejs.history.length&&(vulpejs.historyPageSize=e.history.pageCount,angular.forEach(vulpejs.history,function(e){vulpejs.historyItems.push(JSON.parse(e.content))})),vulpejs.findAfter(vulpejs),vulpejs.doDebug({type:"FIND-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties(),$timeout(function(){vulpejs.focus()},100)})},close:function(e){vulpejs.closeBefore(vulpejs),vulpejs.doDebug({type:"CLONE-BEFORE",item:vulpejs.item}),vulpejs.item=vulpejs.copy(e),delete vulpejs.item._id,vulpejs.showing=!0,clearHistory(),vulpejs.closeAfter(vulpejs),vulpejs.doDebug({type:"CLONE-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties(),$timeout(function(){vulpejs.focus()},100)},remove:function(e){vulpejs.operation="REMOVE";var t=function(){vulpejs.message.clean(),vulpejs.removeBefore(e,function(){$http({method:"DELETE",url:"/"+vulpejs.name+"/"+e}).success(function(){clearItem(!1),vulpejs.list(),vulpejs.message.success("Record successfully deleted!"),vulpejs.removeAfter(vulpejs)}).error(httpErrorHandler)})};$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){t()},function(){})},removeFromArray:function(e,t,s){var o=function(){vulpejs.message.clean(),vulpejs.item[e].splice(s,1)},r=vulpejs.item[e][s][t];r?$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){o()},function(){}):o()},addToArray:function(e,t){vulpejs.message.clean(),vulpejs.item[e].push(t)},clone:function(e){vulpejs.cloneBefore(vulpejs),vulpejs.doDebug({type:"CLONE-BEFORE",item:vulpejs.item}),vulpejs.item=vulpejs.copy(e),vulpejs.oldItem=vulpejs.copy(e),delete vulpejs.item._id,vulpejs.showing=!0,clearHistory(),vulpejs.cloneAfter(vulpejs),vulpejs.doDebug({type:"CLONE-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties(),$timeout(function(){vulpejs.focus()},100)},save:function(e){$rootScope.form.$valid&&(e?vulpejs.saveType=e:(vulpejs.item._id&&(vulpejs.isUpdate=!0),vulpejs.isValid=!0,vulpejs.operation="SAVE",vulpejs.saveBefore(vulpejs),vulpejs.isValid&&(vulpejs.doDebug({type:"SAVE-BEFORE",item:vulpejs.item}),vulpejs.message.clean(),$http.post(vulpejs.rootContext+"/"+vulpejs.name,vulpejs.item).success(function(e){vulpejs.item=e.item,vulpejs.oldItem=e.item,vulpejs.saveType.length>0&&("NEW"===vulpejs.saveType?vulpejs.create():"CLOSE"===vulpejs.saveType&&(vulpejs.create(),vulpejs.showing=!1),vulpejs.saveType=""),vulpejs.message.success("Record successfully saved!"),$timeout(function(){vulpejs.list(),vulpejs.focus()},100),vulpejs.saveAfter(vulpejs),vulpejs.doDebug({type:"SAVE-AFTER",item:vulpejs.item}),vulpejs.doLoadProperties()}).error(httpErrorHandler))))},status:function(e,t){vulpejs.operation="STATUS",vulpejs.message.clean(),vulpejs.statusBefore(vulpejs),$http.post(vulpejs.rootContext+"/"+vulpejs.name+"/status",{id:e,status:t}).success(function(){vulpejs.item._id&&(vulpejs.item.status=t),vulpejs.message.success("Status successfully changed!"),vulpejs.statusAfter(vulpejs),$timeout(function(){vulpejs.list($rootScope.currentPage+1),vulpejs.focus()},100)}).error(httpErrorHandler)},datepicker:function(e){e.preventDefault(),e.stopPropagation(),vulpejs.datepickerOpened=!vulpejs.datepickerOpened},inputFocus:function(e){var t="input[name='"+e+"']",s=$(t).filter(function(){return""==this.value});s.length>0?$(s.get(0)).focus():$(t).focus()},tabNext:function(){vulpejs.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab+1)).find("a").trigger("click")},tabPrevious:function(){vulpejs.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab-1)).find("a").trigger("click")},tabFocus:function(e){e&&e.length>0&&$timeout(function(){vulpejs.focusTo(vulpejs.name+"-"+e)},100)},tabsHotkeys:function(){$(document).bind("keydown.left",function(){return vulpejs.tabPrevious(),!1}).bind("keydown.right",function(){return vulpejs.tabNext(),!1})},focusTo:function(e){$(0!==e.indexOf("#")?"#"+e:e).focus()},checkUncheckAll:function(e){$rootScope.selectAll=!$rootScope.selectAll,angular.forEach($rootScope[e],function(e){e.selected=$rootScope.selectAll})},hasRoles:function(e){for(var t=$authenticator.userDetails(),s=0;s<e.length;s++){var o=e[s];if(-1!==t.roles.indexOf(o))return!0}return!1},equals:function(e,t,s){return e?e[t]===s:!1},typeaheadOnSelect:function(e,t,s){vulpejs.item[e]=t[s]},selectOnChange:function(e,t,s){"undefined"!=typeof vulpejs.item[e]?$rootScope.vulpejs[t].forEach(function(t){t[s]===vulpejs.item[e]&&($rootScope.vulpejs[e]=t)}):delete $rootScope.vulpejs[e]},loadArray:function(e){var t=e.from,s=e.to,o=e.label;$rootScope.vulpejs[s]=[],t=vulpejs.expressionEval(t),t.length>0&&$http.get(t).success(function(e){$rootScope.vulpejs[s]=e.items,o&&angular.forEach($rootScope.vulpejs[s],function(e){if(e.label="",angular.isString(o))e.label+=e[o];else{var t=[],s=" - ";angular.isArray(o)?t=o:angular.isObject(o)&&(t=o.properties,s=o.separator),t.forEach(function(t){e.label.length>0&&(e.label+=s),e.label+=e[t]})}})})},loadProperty:function(options){var from=options.from,to=options.to,when=options.when,fromParts=from.split("."),fromProperty=fromParts.pop();from=null;var toParts=to.split("."),toProperty=toParts.pop();if(to=null,fromParts.forEach(function(e){from=null===from?$rootScope.vulpejs[e]:from[e]}),toParts.forEach(function(e){to=null===to?$rootScope.vulpejs[e]:to[e]}),angular.isArray(from))for(var array=from,i=0;i<array.length;i++)if(from=array[i],eval(when)){to[toProperty]=from[fromProperty];break}},flowFilesSubmit:function(e){e.upload()},onReady:function(e){$(document).ready(function(){vulpe.utils.tryExecute(e)})},hasChanged:function(e,t){if(e||t){for(var s in e)if(t.hasOwnProperty(s)&&t[s]!==e[s])return!0}else for(var s in vulpejs.item)if(vulpejs.oldItem.hasOwnProperty(s)&&vulpejs.oldItem[s]!==vulpejs.item[s])return!0;return!1},copy:function(e){return angular.copy(e)}};if(vulpejs.debug=$cookieStore.get("debug")||vulpejs.debug,window.location.search){var search=window.location.search.substring(1),status=function(e){var t=e.split("=");"status"===t[0]&&(vulpejs.filter.status=t[1])};if(vulpejs.queryString={},-1!==search.indexOf("&"))search.split("&").forEach(function(e){var t=e.split("=");vulpejs.queryString[t[0]]=t[1],-1!==e.indexOf("status=")&&status(e)});else{var parts=search.split("=");vulpejs.queryString[parts[0]]=parts[1],status(search)}}var service=function(e){e?(vulpejs.debug=e.debug||!1,vulpejs.name=e.name,vulpejs.listUrl=e.listUrl||"/"+e.name+"s",vulpejs.predicate=e.predicate||"",e.populate&&(vulpejs.populate=e.populate),e.focus&&(vulpejs.focus=function(){if(angular.isFunction(e.focus))e.focus(vulpejs);else{var t="#"+e.name.replace(/\-/g,"")+"-";angular.isObject(e.focus)?$(t+(vulpejs.item._id?e.focus.edit:e.focus.new)).focus():$(t+e.focus).focus()}}),e.messages&&(vulpejs.messages=e.messages),vulpejs.hotkeys=e.hotkeys||nothing,e.list&&(e.list.filter&&(vulpejs.listFilter=e.list.filter),vulpejs.listBefore=e.list.before||nothing,vulpejs.listAfter=e.list.after||nothing),e.actions&&(vulpejs.newItem=e.actions.newItem||nothing,e.actions.focus&&(vulpejs.focus=e.actions.focus),vulpejs.validate=e.actions.validate||nothing,vulpejs.createBefore=e.actions.createBefore||nothing,vulpejs.createAfter=e.actions.createAfter||nothing,vulpejs.cloneBefore=e.actions.cloneBefore||nothing,vulpejs.cloneAfter=e.actions.cloneAfter||nothing,vulpejs.findBefore=e.actions.findBefore||nothing,vulpejs.findAfter=e.actions.findAfter||nothing,vulpejs.saveBefore=e.actions.saveBefore||nothing,vulpejs.saveAfter=e.actions.saveAfter||nothing,vulpejs.statusBefore=e.actions.statusBefore||nothing,vulpejs.statusAfter=e.actions.statusAfter||nothing,e.actions.removeBefore&&($rootScop.vulpejse.removeBefore=e.actions.removeBefore),vulpejs.removeAfter=e.actions.removeAfter||nothing,vulpejs.cancelBefore=e.actions.cancelBefore||nothing,vulpejs.cancelAfter=e.actions.cancelAfter||nothing),e.load&&(vulpejs.loadArrays=e.load.arrays||[],vulpejs.loadProperties=e.load.properties||[]),e.error&&(vulpejs.errorHandler=e.error.handle||nothing),vulpejs.init=e.init||nothing):vulpejs.debug=!1},httpErrorHandler=function(e,t,s,o){angular.isFunction($rootScope.errorHandler)?vulpejs.errorHandler({operation:vulpejs.operation,data:e,status:t,header:s,config:o,vulpejs:vulpejs}):e.validate?e.validate.exists&&("SAVE"===vulpejs.operation?vulpejs.message.info(vulpejs.messages.validate.save.exists):"REMOVE"===vulpejs.operation&&vulpejs.message.info(vulpejs.messages.validate.remove.exists)):vulpejs.message.error("An error occurred in the execution.")},clearHistory=function(){vulpejs.history=[],vulpejs.historyItems=[],vulpejs.historyVersion=null},clearItem=function(e){vulpejs.item=vulpejs.newItem(vulpejs),vulpejs.item=vulpejs.propertiesEval(vulpejs.item),vulpejs.oldItem=vulpejs.copy(vulpejs.item),vulpejs.showing=e,clearHistory()},addJSONValue=function(e,t,s){var o=JSON.stringify(e);return o=o.substring(0,o.length-1)+', "'+t+'":"'+s+'"}',JSON.parse(e)};return service.prototype.init=function(e){return $authenticator.userDetails(),vulpejs.init(vulpejs),application.init&&vulpe.utils.tryExecute(application.init),e&&$(document).ready(function(){e.mainForm&&($rootScope.form=e.mainForm),e.multiSelectTranslation={selectAll:i18n.__("Select all"),selectNone:i18n.__("Select none"),reset:i18n.__("Reset"),search:i18n.__("Search"),nothingSelected:i18n.__("Nothing is selected")}}),vulpejs.name&&(clearItem(!1),vulpejs.validate(),vulpejs.list(),vulpejs.loadArrays.length>0&&angular.forEach(vulpejs.loadArrays,function(e){vulpejs.loadArray(e)}),vulpejs.hotkeys(),vulpejs.tabsHotkeys(),vulpejs.focus()),$rootScope.vulpejs},service.prototype.store=$store,$rootScope.vulpejs=vulpejs,service}]);