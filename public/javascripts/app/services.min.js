"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(o,e){var t="undefined"==typeof window.localStorage?void 0:window.localStorage,r=!("undefined"==typeof t||"undefined"==typeof window.JSON),s={parseValue:function(o){var e;try{e=JSON.parse(o),"undefined"==typeof e&&(e=o),"true"==e&&(e=!0),"false"==e&&(e=!1),parseFloat(e)!=e||angular.isObject(e)||(e=parseFloat(e))}catch(t){e=o}return e}},c={set:function(o,c){if(!r)try{return e.set(o,c),c}catch(n){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var i=JSON.stringify(c);return t.setItem(o,i),s.parseValue(i)},get:function(o){if(!r)try{return s.parseValue(e.get(o))}catch(c){return null}var n=t.getItem(o);return s.parseValue(n)},remove:function(o){if(!r)try{return e.remove(o),!0}catch(s){return!1}return t.removeItem(o),!0},bind:function(e,t,r){return r=r||"",c.get(t)||c.set(t,r),o(t).assign(e,c.get(t)),e.$watch(t,function(o){c.set(t,o)},!0),c.get(t)}};return c}]),app.factory("$authenticator",["$rootScope","$store",function(o,e){return o.userDetails={},{userDetails:function(){return o.userDetails=e.get("userDetails"),o.userDetails},loginSuccessfully:function(t){o.userDetails=t,e.set("userDetails",o.userDetails)},updateUserDetails:function(){e.set("userDetails",rootScope.userDetails)},logoutSuccessfully:function(){this.userIsAuthenticated=!1,e.remove("userDetails"),e.remove("userIsAuthenticated"),application&&application.login&&application.login.arrays&&application.login.arrays.forEach(function(o){e.remove(o)})}}}]),app.factory("$messages",["$rootScope",function(o){return{type:"",message:"",addMessage:function(o,e){this.type=o,this.message=e,this.broadcastMessage()},addErrorMessage:function(o){this.type="danger",this.message=o,this.broadcastMessage()},addInfoMessage:function(o){this.type="info",this.message=o,this.broadcastMessage()},addWarningMessage:function(o){this.type="warning",this.message=o,this.broadcastMessage()},addSuccessMessage:function(o){this.type="success",this.message=o,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){o.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){o.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("AppManager",["$rootScope","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store","$cookieStore","$sce",function($rootScope,$http,$authenticator,$messages,$dialogs,$timeout,i18n,$store,$cookieStore,$sce){$rootScope.debug=$cookieStore.get("debug")||$rootScope.debug,$rootScope.onlyNumbers=/^\d+$/,$rootScope.showing=!1,$rootScope.form={},$rootScope.name="",$rootScope.listUrl="",$rootScope.predicate="",$rootScope.reverse=!0,$rootScope.populate=!1,$rootScope.item={},$rootScope.items=[],$rootScope.history=[],$rootScope.historyItems=[],$rootScope.historyVersion=null,$rootScope.saveType="",$rootScope.selectedTab=0,$rootScope.messages={validate:{save:{exists:"This record already exists."},remove:{exists:"This record is being used by another registry and can not be deleted."}}};var nothing=function(){},empty=function(){return""};if($rootScope.newItem=nothing,$rootScope.focus=nothing,$rootScope.hotkeys=nothing,$rootScope.listFilter=function(o){return o.filter.status?"/status/"+o.filter.status:""},$rootScope.listBefore=nothing,$rootScope.listAfter=nothing,$rootScope.validate=nothing,$rootScope.createBefore=nothing,$rootScope.createAfter=nothing,$rootScope.findBefore=nothing,$rootScope.findAfter=nothing,$rootScope.saveBefore=nothing,$rootScope.saveAfter=nothing,$rootScope.cancelBefore=nothing,$rootScope.cancelAfter=nothing,$rootScope.statusBefore=nothing,$rootScope.statusAfter=nothing,$rootScope.removeBefore=function(o,e){e()},$rootScope.removeAfter=nothing,$rootScope.loadArrays=[],$rootScope.loadProperties=[],$rootScope.doLoadProperties=function(){$rootScope.loadProperties.length>0&&$rootScope.loadProperties.forEach(function(o){$rootScope.loadProperty(o)})},$rootScope.init=nothing,$rootScope.errorHandler={},$rootScope.filter={status:""},window.location.search){var search=window.location.search.substring(1),status=function(o){var e=o.split("=");"status"===e[0]&&($rootScope.filter.status=e[1])};-1!==search.indexOf("&")?search.split("&").forEach(function(o){-1!==o.indexOf("status=")&&status(o)}):status(search)}$rootScope.doDebug=function(o){$rootScope.debug&&console.debug(o)};var service=function(o){$rootScope.debug=o.debug||!1,$rootScope.name=o.name,$rootScope.listUrl=o.listUrl||"/"+o.name+"s",$rootScope.predicate=o.predicate||"",o.populate&&($rootScope.populate=o.populate),o.focus&&($rootScope.focus=function(){if(angular.isFunction(o.focus))o.focus({$rootScope:$rootScope});else{var e="#"+o.name.replace(/\-/g,"")+"-";angular.isObject(o.focus)?$(e+($rootScope.item._id?o.focus.edit:o.focus.new)).focus():$(e+o.focus).focus()}}),o.messages&&($rootScope.messages=o.messages),$rootScope.hotkeys=o.hotkeys||nothing,o.list&&(o.list.filter&&($rootScope.listFilter=o.list.filter),$rootScope.listBefore=o.list.before||nothing,$rootScope.listAfter=o.list.after||nothing),o.actions&&($rootScope.newItem=o.actions.newItem||nothing,o.actions.focus&&($rootScope.focus=o.actions.focus),$rootScope.validate=o.actions.validate||nothing,$rootScope.createBefore=o.actions.createBefore||nothing,$rootScope.createAfter=o.actions.createAfter||nothing,$rootScope.cloneBefore=o.actions.cloneBefore||nothing,$rootScope.cloneAfter=o.actions.cloneAfter||nothing,$rootScope.findBefore=o.actions.findBefore||nothing,$rootScope.findAfter=o.actions.findAfter||nothing,$rootScope.saveBefore=o.actions.saveBefore||nothing,$rootScope.saveAfter=o.actions.saveAfter||nothing,$rootScope.statusBefore=o.actions.statusBefore||nothing,$rootScope.statusAfter=o.actions.statusAfter||nothing,o.actions.removeBefore&&($rootScope.removeBefore=o.actions.removeBefore),$rootScope.removeAfter=o.actions.removeAfter||nothing,$rootScope.cancelBefore=o.actions.cancelBefore||nothing,$rootScope.cancelAfter=o.actions.cancelAfter||nothing),o.load&&($rootScope.loadArrays=o.load.arrays||[],$rootScope.loadProperties=o.load.properties||[]),o.error&&($rootScope.errorHandler=o.error.handle||nothing),$rootScope.init=o.init||nothing},options={$rootScope:$rootScope,$store:$store,$authenticator:$authenticator,$http:$http,$messages:$messages,$dialogs:$dialogs,$timeout:$timeout,i18n:i18n,filter:$rootScope.filter};$rootScope.currentPage=0,$rootScope.pageSize=1,$rootScope.historyCurrentPage=0,$rootScope.historyPageSize=1,$rootScope.previousPage=function(o){$messages.cleanAllMessages(),o&&$rootScope.historyCurrentPage>0?($rootScope.historyCurrentPage--,$rootScope.historyList($rootScope.historyCurrentPage),$rootScope.historyVersion=null):$rootScope.currentPage>0&&($rootScope.currentPage--,$rootScope.list($rootScope.currentPage))},$rootScope.nextPage=function(o){$messages.cleanAllMessages(),o&&$rootScope.historyCurrentPage<$rootScope.historyPageSize-1?($rootScope.historyCurrentPage++,$rootScope.historyList($rootScope.historyCurrentPage+1),$rootScope.historyVersion=null):$rootScope.currentPage<$rootScope.pageSize-1&&($rootScope.currentPage++,$rootScope.list($rootScope.currentPage+1))},$rootScope.setPage=function(o){o?($messages.cleanAllMessages(),$rootScope.historyCurrentPage=this.n,$rootScope.historyList($rootScope.historyCurrentPage+1),$rootScope.historyVersion=null):($messages.cleanAllMessages(),$rootScope.currentPage=this.n,$rootScope.list($rootScope.currentPage+1))},$rootScope.range=function(o,e){var t=[];e||(e=o,o=0);for(var r=o;e>r;r++)t.push(r);return t},$rootScope.trustSrc=function(o){return $sce.trustAsResourceUrl(o)};var httpErrorHandler=function(o,e,t,r){angular.isFunction($rootScope.errorHandler)?$rootScope.errorHandler({operation:$rootScope.operation,data:o,status:e,header:t,config:r,$messages:$messages}):o.validate?o.validate.exists&&("SAVE"===$rootScope.operation?$messages.addInfoMessage($rootScope.messages.validate.save.exists):"REMOVE"===$rootScope.operation&&$messages.addInfoMessage($rootScope.messages.validate.remove.exists)):$messages.addErrorMessage("An error occurred in the execution.")};$rootScope.expressionEval=function(o){var e=o;if(/\{(.*)\}/.test(o)){var t=o.match(/\{(.*)\}/),r=t[1].split(":");e=e.replace(t[0],"");var s="";if(r.length>1)if(-1!==r[1].indexOf(".")){var c=r[1].split(".");s="store"===r[0]?$store.get(c[0])?$store.get(c[0])[c[1]]:"":$rootScope[c[0]]?$rootScope[c[0]][c[1]]:""}else s="store"===r[0]?$store.get(r[1])?$store.get(r[1]):"":$rootScope[r[1]]?$rootScope[r[1]]:"";else if(-1!==r[0].indexOf(".")){var c=r[0].split(".");s=$rootScope[c[0]][c[1]]}else s=$rootScope[r[0]];0===s.length?e="":e+=s}return e},$rootScope.propertiesEval=function(o){if(angular.isObject(o))for(var e in o)angular.isArray(o[e])?o[e].forEach(function(o){o=$rootScope.propertiesEval(o)}):o[e]=angular.isObject(o[e])?$rootScope.propertiesEval(o[e]):$rootScope.expressionEval(o[e]);return o};var clearHistory=function(){$rootScope.history=[],$rootScope.historyItems=[],$rootScope.historyVersion=null},clearItem=function(o){$rootScope.item=$rootScope.newItem(options),$rootScope.item=$rootScope.propertiesEval($rootScope.item),$rootScope.showing=o,clearHistory()};$rootScope.create=function(){$rootScope.createBefore(options),$rootScope.doDebug({type:"CREATE-BEFORE",item:$rootScope.item}),clearItem(!0),$timeout(function(){$rootScope.focus()},100),$rootScope.createAfter(options),$rootScope.doDebug({type:"CREATE-AFTER",item:$rootScope.item})},$rootScope.cancel=function(){$rootScope.cancelBefore(options),$rootScope.doDebug({type:"CANCEl-BEFORE",item:$rootScope.item}),clearItem(!1),$rootScope.cancelAfter(options),$rootScope.doDebug({type:"CANCEl-AFTER",item:$rootScope.item})},$rootScope.historyCopy=function(){var o=angular.isObject($rootScope.historyVersion);if($rootScope.form.historySelected.$setValidity("historyNotSelected",o),o){var e=$rootScope.item.version;$rootScope.item=$rootScope.historyVersion,e&&($rootScope.item.version=e)}},$rootScope.list=function(o){o||(o=1,$rootScope.currentPage=0),$rootScope.listBefore(options),$rootScope.doDebug({type:"LIST-BEFORE",items:$rootScope.items});var e=$rootScope.listFilter(options);e+="/page/"+o,$http.get(vulpejs.ng.rootContext+$rootScope.listUrl+e).success(function(o){$rootScope.items=o.items,$rootScope.pageSize=o.pageCount,$rootScope.listAfter(options),$rootScope.doDebug({type:"LIST-AFTER",items:$rootScope.items})})},$rootScope.historyList=function(o){clearHistory(),o||(o=1),$http.get(vulpejs.ng.rootContext+$rootScope.name+"/history/"+$rootScope.item._id+"/page/"+o).success(function(o){$rootScope.history=o.items,0!==$rootScope.history.length&&($rootScope.historyPageSize=o.pageCount,angular.forEach($rootScope.history,function(o){$rootScope.historyItems.push(JSON.parse(o.content))}))})},$rootScope.find=function(o){$rootScope.findBefore(options),$rootScope.doDebug({type:"FIND-BEFORE",item:$rootScope.item}),$http.get(vulpejs.ng.rootContext+"/"+$rootScope.name+($rootScope.populate?"/populate":"")+"/"+o).success(function(o){$rootScope.item=o.item,$rootScope.showing=!$rootScope.showing,$rootScope.history=o.history.items,0!==$rootScope.history.length&&($rootScope.historyPageSize=o.history.pageCount,angular.forEach($rootScope.history,function(o){$rootScope.historyItems.push(JSON.parse(o.content))})),$rootScope.findAfter(options),$rootScope.doDebug({type:"FIND-AFTER",item:$rootScope.item}),$rootScope.doLoadProperties(),$timeout(function(){$rootScope.focus()},100)})},$rootScope.clone=function(o){$rootScope.cloneBefore(options),$rootScope.doDebug({type:"CLONE-BEFORE",item:$rootScope.item}),$rootScope.item=angular.copy(o),delete $rootScope.item._id,$rootScope.showing=!0,clearHistory(),$rootScope.cloneAfter(options),$rootScope.doDebug({type:"CLONE-AFTER",item:$rootScope.item}),$rootScope.doLoadProperties(),$timeout(function(){$rootScope.focus()},100)},$rootScope.remove=function(o){$rootScope.operation="REMOVE";var e=function(){$messages.cleanAllMessages(),$rootScope.removeBefore(o,function(){$http({method:"DELETE",url:"/"+$rootScope.name+"/"+o}).success(function(){clearItem(!1),$rootScope.list(),$messages.addSuccessMessage("Record successfully deleted!"),$rootScope.removeAfter(options)}).error(httpErrorHandler)})};$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){e()},function(){})},$rootScope.removeFromArray=function(o,e,t){var r=function(){$messages.cleanAllMessages(),$rootScope.item[o].splice(t,1)},s=$rootScope.item[o][t][e];s?$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){r()},function(){}):r()},$rootScope.addToArray=function(o,e){$messages.cleanAllMessages(),$rootScope.item[o].push(e)};var addJSONValue=function(o,e,t){var r=JSON.stringify(o);return r=r.substring(0,r.length-1)+', "'+e+'":"'+t+'"}',JSON.parse(o)};return $rootScope.save=function(o){$rootScope.form.$valid&&(o?$rootScope.saveType=o:($rootScope.operation="SAVE",$rootScope.saveBefore(options),$rootScope.doDebug({type:"SAVE-BEFORE",item:$rootScope.item}),$messages.cleanAllMessages(),$http.post(vulpejs.ng.rootContext+"/"+$rootScope.name,$rootScope.item).success(function(o){$rootScope.item=o.item,$rootScope.saveType.length>0&&("NEW"===$rootScope.saveType?$rootScope.create():"CLOSE"===$rootScope.saveType&&($rootScope.create(),$rootScope.showing=!1),$rootScope.saveType=""),$messages.addSuccessMessage("Record successfully saved!"),$timeout(function(){$rootScope.list(),$rootScope.focus()},100),$rootScope.saveAfter(options),$rootScope.doDebug({type:"SAVE-AFTER",item:$rootScope.item}),$rootScope.doLoadProperties()}).error(httpErrorHandler)))},$rootScope.status=function(o,e){$rootScope.operation="STATUS",$messages.cleanAllMessages(),$rootScope.statusBefore(options),$http.post(vulpejs.ng.rootContext+"/"+$rootScope.name+"/status",{id:o,status:e}).success(function(){$rootScope.item._id&&($rootScope.item.status=e),$messages.addSuccessMessage("Status successfully changed!"),$rootScope.statusAfter(options),$timeout(function(){$rootScope.list($rootScope.currentPage+1),$rootScope.focus()},100)}).error(httpErrorHandler)},$rootScope.datepicker=function(o){o.preventDefault(),o.stopPropagation(),$rootScope.datepickerOpened=!$rootScope.datepickerOpened},$rootScope.inputFocus=function(o){var e="input[name='"+o+"']",t=$(e).filter(function(){return""==this.value});t.length>0?$(t.get(0)).focus():$(e).focus()},$rootScope.tabNext=function(){$rootScope.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab+1)).find("a").trigger("click")},$rootScope.tabPrevious=function(){$rootScope.showing&&$($("li.ng-isolate-scope").get($rootScope.selectedTab-1)).find("a").trigger("click")},$rootScope.tabFocus=function(o){o&&o.length>0&&$timeout(function(){$rootScope.focusTo($rootScope.name+"-"+o)},100)},$rootScope.tabsHotkeys=function(){$(document).bind("keydown.left",function(){return $rootScope.tabPrevious(),!1}).bind("keydown.right",function(){return $rootScope.tabNext(),!1})},$rootScope.focusTo=function(o){$(0!==o.indexOf("#")?"#"+o:o).focus()},$rootScope.checkUncheckAll=function(o){$rootScope.selectAll=!$rootScope.selectAll,angular.forEach($rootScope[o],function(o){o.selected=$rootScope.selectAll})},$rootScope.hasRoles=function(o){for(var e=$authenticator.userDetails(),t=0;t<o.length;t++){var r=o[t];if(-1!==e.roles.indexOf(r))return!0}return!1},$rootScope.equals=function(o,e,t){return o?o[e]===t:!1},$rootScope.typeaheadOnSelect=function(o,e,t){$rootScope.item[o]=e[t]},$rootScope.selectOnChange=function(o,e,t){"undefined"!=typeof $rootScope.item[o]&&$rootScope[e].forEach(function(e){e[t]===$rootScope.item[o]&&($rootScope[o]=e)})},$rootScope.loadArray=function(o){var e=o.from,t=o.to,r=o.label;$rootScope[t]=[],e=$rootScope.expressionEval(e),e.length>0&&$http.get(e).success(function(o){$rootScope[t]=o.items,r&&angular.forEach($rootScope[t],function(o){if(o.label="",angular.isString(r))o.label+=o[r];else{var e=[],t=" - ";angular.isArray(r)?e=r:angular.isObject(r)&&(e=r.properties,t=r.separator),e.forEach(function(e){o.label.length>0&&(o.label+=t),o.label+=o[e]})}})})},$rootScope.loadProperty=function(options){var from=options.from,to=options.to,when=options.when,fromParts=from.split("."),fromProperty=fromParts.pop();from=null;var toParts=to.split("."),toProperty=toParts.pop();if(to=null,fromParts.forEach(function(o){from=null===from?$rootScope[o]:from[o]}),toParts.forEach(function(o){to=null===to?$rootScope[o]:to[o]}),angular.isArray(from))for(var array=from,i=0;i<array.length;i++)if(from=array[i],eval(when)){to[toProperty]=from[fromProperty];break}},$rootScope.flowFilesSubmit=function(o){o.upload()},service.prototype.init=function(o){$authenticator.userDetails(),$rootScope.init(options),application.init&&vulpejs.util.tryExecute(application.init),o&&$(document).ready(function(){o.mainForm&&($rootScope.form=o.mainForm),o.multiSelectTranslation={selectAll:i18n.__("Select all"),selectNone:i18n.__("Select none"),reset:i18n.__("Reset"),search:i18n.__("Search"),nothingSelected:i18n.__("Nothing is selected")}}),clearItem(!1),$rootScope.validate(),$rootScope.list(),$rootScope.loadArrays.length>0&&angular.forEach($rootScope.loadArrays,function(o){$rootScope.loadArray(o)}),$rootScope.hotkeys(),$rootScope.tabsHotkeys(),$rootScope.focus()},service.prototype.store=$store,service}]);